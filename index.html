<html>
    <header>
        <title>Volta+</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <script src="https://cdn.anychart.com/releases/8.7.1/js/anychart-core.min.js"></script>
        <script src="https://cdn.anychart.com/releases/8.7.1/js/anychart-cartesian.min.js"></script>
        <style>
            * {
                font-size: 23px;
                border-radius: 0 !important;
            }
        </style>
    </header>
    <body>
        <div id="meter_modal" class="modal">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content" style="max-height: 75vh;">
                    <div class="modal-header">
                        <h4 id="station_name"></h4>
                    </div>
                    <div class="modal-body overflow-auto" style="margin: 2.5vh 0;">
                        <table id="meters" style="width: 100%;"></table>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div style="height: 10vh;">
                <h1 style="text-align: center;">Volta+</h1>
            </div>
            <div class="row" style="height: 45vh;">
                <div class="col-md-2" style="height: 100%;">
                    <div id="states" class="list-group list-group-flush overflow-auto" style="height: 100%; background-color: #f8f9fa;"></div>
                </div>
                <div class="col-md-4" style="height: 100%;">
                    <div id="cities" class="list-group list-group-flush overflow-auto" style="height: 100%; background-color: #f8f9fa;"></div>
                </div>
                <div class="col-md-6" style="height: 100%;">
                    <div id="sites" class="list-group list-group-flush overflow-auto" style="height: 100%; background-color: #f8f9fa;"></div>
                </div>
            </div>
            <div class="overflow-auto" style="height: 40vh; margin: 2.5vh 0; background-color: #f8f9fa;">
                <div id="stations" class="list-group list-group-flush"></div>
            </div>
        </div>
        <script>
            API_URL = "https://voltaplus.azurewebsites.net/"
            DAYS = ["Mon", "Tues", "Wed", "Thu", "Fri", "Sat", "Sun"];
            CURR_DAY_OF_WEEK = (new Date().getDay() + 6) % 7;

            $.getJSON(API_URL + '/sites', function(json) {
                $.each(json, function(i, obj) {
                    $('#states').append($('<button>', {
                        text: i.toUpperCase(),
                        class: 'list-group-item list-group-item-action',
                        style: 'padding: .25em .5em; min-height: fit-content;'
                    }).click(function() {
                        $('#states').children('button').each(function() {
                            $(this).removeClass('active')
                        });
                        $(this).addClass('active');
                        updateCities(obj);
                    }));
                });
            }).done(function() {
                let params = (new URL(document.location)).searchParams;
                defaultState = params.get('state');
                if (defaultState != null) {
                    for (var state of $('#states').children()) {
                        if ($(state).text().toLowerCase() == defaultState.toLowerCase()) {
                            state.click();
                            break;
                        }
                    }
                }
                defaultCity = params.get('city');
                if (defaultCity != null) {
                    for (var city of $('#cities').children()) {
                        if ($(city).text().toLowerCase() == defaultCity.toLowerCase()) {
                            city.click();
                            break;
                        }
                    }
                }
                defaultSite = params.get('site');
                if (defaultSite != null) {
                    for (var city of $('#sites').children()) {
                        if ($(site).text().toLowerCase() == defaulSite.toLowerCase()) {
                            site.click();
                            break;
                        }
                    }
                }
            });

            function updateCities(cities) {
                $('#cities').empty();
                $('#sites').empty();
                var toTitleCase = function(str) {
                    return str.split(' ').map((s) => s.charAt(0).toUpperCase() + s.substring(1)).join(' ');
                };
                $.each(cities, function(city, sites) {
                    $('#cities').append($('<button>', {
                        text: toTitleCase(city),
                        class: 'list-group-item list-group-item-action',
                        style: 'padding: .25em .5em; min-height: fit-content;'
                    }).click(function() {
                        $('#cities').children('button').each(function() {
                            $(this).removeClass('active')
                        });
                        $(this).addClass('active');
                        updateSites(sites);
                    }));
                });
                if ($('#cities').children().length == 1)
                    $('#cities').children()[0].click();
            }

            function updateSites(sites) {
                $('#sites').empty();
                for (var site of sites) {
                    $('#sites').append($('<button>', {
                        text: site[0],
                        class: 'list-group-item list-group-item-action',
                        style: 'padding: .25em .5em; min-height: fit-content;'
                    }).click(function(stations) {
                        return function() {
                            $('#sites').children('button').each(function() {
                                $(this).removeClass('active')
                            });
                            $(this).addClass('active');
                            updateStations(stations);
                        };
                    }(site[1])));
                }
                if ($('#sites').children().length == 1)
                    $('#sites').children()[0].click();
            }

            function updateStations(stations) {
                $('#stations').empty();
                for (var station of stations) {
                    $.getJSON(API_URL + '/meters/' + station['meters'].join(','), function(json) {
                        var stationName = this['name'];
                        var button = $('<div>', {
                            text: stationName,
                        });
                        var brief = $('<button>', {
                            class: 'list-group-item list-group-item-action',
                            style: 'padding: .25em .5em; min-height: fit-content;'
                        }).click(function() {
                            showMeters(stationName, json);
                        });
                        brief.append(button);
                        for (var meter of json) {
                            var status = $('<div>', {
                                style: 'padding: 0 1em;'
                            });
                            status.append($('<span/>', {
                                class: 'material-icons',
                                style: 'vertical-align: text-top; padding-right:.25em;',
                                text: 'ev_station'
                            }));
                            if (meter['availability'] == 'available')
                                status.addClass('text-secondary');
                            else if (meter['availability'] == 'in use' || meter['availability'] == 'plugged in...') {
                                status.addClass((meter['state'] == 'chargestopped' || meter['charge_duration'] > 7200) ? 'text-warning' : 'text-primary');
                                status.append($('<span/>', {
                                    text: durationFmt(meter['charge_duration'])
                                }));
                            }
                            else
                                status.addClass('text-danger');
                            brief.append(status);
                        }
                        $('#stations').append(brief);
                    }.bind(station));
                }
            }

            function durationFmt(totalSeconds) {
                var hours = Math.floor(totalSeconds / 3600)
                var minutes = Math.floor(totalSeconds / 60) % 60
                var seconds = totalSeconds % 60;

                if (hours == 0 && minutes == 0) return seconds + "sec";

                fmt = String();
                if (hours > 0) fmt += hours + "hr";
                if (minutes > 0) {
                    if (fmt.length > 0) fmt += ' ';
                    fmt += minutes + "min";
                }

                return fmt
            }

            function showMeters(name, data) {
                $('#station_name').text(name);

                for (var meter in data) {
                    var meterStats = $('<tr>');
                    if (meter > 0) meterStats.append($('<hr>'));
                    var currProgressBar = $('<div>', {
                        class: 'progress-bar',
                        width: ((data[meter]['charge_duration'] / 7200) * 100) + '%'
                    });

                    var showCurrCharge = false;
                    if (data[meter]['availability'] == 'in use' || data[meter]['availability'] == 'plugged in...') {
                        if (data[meter]['state'] == 'chargestopped') {
                            currProgressBar.addClass('bg-warning');
                        } else if (data[meter]['charge_duration'] > 7200) {
                            currProgressBar.addClass('bg-warning progress-bar-striped progress-bar-animated');
                        } else {
                            currProgressBar.addClass('progress-bar-striped progress-bar-animated')
                        }
                        showCurrCharge = true;
                    }

                    if (showCurrCharge) {
                        meterStats.append($('<h5/>', {
                            text: 'current charge'
                        }));
                        var currCharge = $('<div>', {
                            class: 'row',
                            style: 'margin: 0 1em; display: flex; align-items: center;'
                        });
                        var currProgress = $('<div>', {
                            class: 'progress'
                        });
                        currProgress.append(currProgressBar);
                        currCharge.append($('<div>', {
                            class: 'col-md-8',
                            style: 'padding-left: 0;'
                        }).append(currProgress));
                        currCharge.append($('<span/>', {
                            class: 'col-md-4',
                            text: durationFmt(data[meter]['charge_duration'])
                        }));
                        meterStats.append(currCharge);
                    }

                    meterStats.append($('<h5/>', {
                        text: 'average charge'
                    }));
                    meterStats.append($('<div/>', {
                        text: durationFmt(data[meter]['in_use_charging_stats']['avg']),
                        style: 'margin: 0 1em;'
                    }));

                    meterStats.append($('<h5/>', {
                        text: "average 'squat'"
                    }));
                    meterStats.append($('<div/>', {
                        text: durationFmt(data[meter]['in_use_stopped_stats']['avg']),
                        style: 'margin: 0 1em;'
                    }));

                    meterStats.append($('<h5/>', {
                        text: 'popular times'
                    }));
                    var popularTimes = $('<div>', {
                        style: 'margin: 0 1em;'
                    });
                    popularTimes.append(weeklyPagination(meter, data[meter]['weekly_usage']));
                    popularTimes.append($('<div>', {
                        id: 'chart_' + meter
                    }));
                    meterStats.append(popularTimes);

                    $('#meters').append(meterStats)
                    $('#' + CURR_DAY_OF_WEEK + '_' + meter).click();
                }
                $('#meter_modal').modal('show');
            }

            function weeklyPagination(idx, data) {
                var pagination = $('<ul>', {
                    id: 'pagination_' + idx,
                    class: 'pagination pagination-sm justify-content-center'
                });
                for (var day in DAYS) {
                    var page = $('<li/>', {
                        id: day + '_' + idx,
                        class: 'page-item'
                    }).append($('<a/>', {
                        class: 'page-link',
                        text: DAYS[day],
                        href: "#"
                    }));
                    var chartData = [];
                    for (var i = 0; i < 144; i += 12) {
                        var hour = i / 6;
                        chartData.push([((hour % 12) + 1) + ((hour > 12) ? 'pm' : 'am'), data[day].slice(i, i + 12).reduce((a, b) => a + b, 0)]);
                    }
                    page.click(function(idx, data) {
                        return function() {
                            $('#pagination_' + idx).children('li').each(function() {
                                $(this).removeClass('active')
                            });
                            $(this).addClass('active');
                            makeMeterChart(idx, data)
                        }
                    }(idx, chartData));
                    pagination.append(page);
                }
                return pagination;
            }

            function makeMeterChart(idx, data) {
                $('#chart_' + idx).empty();
                var chart = anychart.column();
                chart.tooltip(false);
                var dataSet = anychart.data.set(data);
                var mapping = dataSet.mapAs({
                    x: 0,
                    value: 1
                });
                chart.yAxis().enabled(false);
                chart.xAxis().ticks().enabled(false);
                var series = chart.column(mapping);
                series.normal().fill('#007bff');
                series.normal().stroke(null);
                series.hovered().fill('#007bff');
                series.hovered().stroke(null);
                series.selected().fill('#007bff');
                series.selected().stroke(null);

                chart.container('chart_' + idx);
                chart.draw();
            }

            window.onclick = function(event) {
                if (event.target == document.getElementById("meter_modal")) {
                    $('#meters').empty();
                    $('#meter_modal').modal('hide')
                }
            }
        </script>
    </body>
</html>